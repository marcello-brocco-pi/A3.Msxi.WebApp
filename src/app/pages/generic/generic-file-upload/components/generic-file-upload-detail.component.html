<div class="card">
    <div class="font-semibold text-lg mb-4">{{"Invio File" | translate}}</div>
    <p-fluid>
        <div [formGroup]="fileUploadForm!">
            <div class="flex flex-col md:flex-row gap-6">
                <div class="flex flex-wrap gap-2 w-full">
                    <label for="categoria">{{categoryTitle}} {{"Documento" | translate}}*</label>
                    <p-select name="categoria" formControlName="categoriaObj" appendTo="body" [attr.disabled]="{componentDisabled}"  required
                    emptyMessage=" " (onChange)="changeSelCategoria()"  [filter]="true" filterBy="name" [showClear]="true" [options]="categorieList" dataKey="id" optionLabel="name" class="w-full"></p-select>                                                                                                             
                </div>
                <div class="flex flex-wrap gap-2 w-full">
                    <p-button [disabled]="fileUploadStatus!=0" icon="pi pi-plus"  class="p-button-rounded p-button-warning mt-6" label="{{'Aggiungi files' | translate}}" (click)="onAddUploadedItem()"></p-button>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-6">
                <div class="flex flex-wrap gap-2 w-full">                  
                     <small class="text-red-500 mt-2" *ngIf="(categoriaObj?.touched || categoriaObj?.dirty) && categoriaObj?.errors?.['required']">
                            {{'Campo' | translate}} {{categoryTitle}} {{"Documento" | translate}} {{"richiesto" | translate}}</small>  
                </div>
                
                  <!-- <div class="flex flex-wrap gap-2 w-full">                  
                         <small class="text-red-500" *ngIf="(pagesFilter?.touched || pagesFilter?.dirty) && pagesFilter?.errors?.['format']">
                    {{"Inserire un valore per valido per Filtro Pagine." | translate}}</small>    
                 </div> -->

                 <div class="flex flex-wrap gap-2 w-full">                  
                 </div>
            </div>

            <div class="flex flex-col md:flex-row gap-6 mt-6">
                @for (dynamicControl of dynamicFieldsFormControls; track $index){
                    @switch (dynamicControl.fieldInfo?.type) {
                        @case ('string') {
                            <div class="flex flex-wrap gap-2 w-full">
                                <label for="{{dynamicControl.key}}">{{dynamicControl.fieldInfo!.label}}</label>
                                <input name="{{dynamicControl.key}}" pInputText type="text" [formControlName]="dynamicControl.key"/>
                            </div>
                            }                                       
                        }   
                    }
            </div>

            <div class="flex flex-col md:flex-row gap-6">
                <div class="flex flex-wrap gap-2 w-full">
                    <hr>
                    <table [hidden]="!filesToUpload || filesToUpload.length === 0" class="min-w-full divide-y divide-gray-200 dark:divide-neutral-700">
                    <thead>
                        <tr>
                            <th scope="col" class="px-6 py-3 text-black-500 dark:text-neutral-500" style="text-align:left; width:70%"></th>
                            <th scope="col" class="px-6 py-3 text-black-500 dark:text-neutral-500" style="text-align:center">{{'Filtro Pagine' | translate}}</th>
                            <th scope="col" class="px-6 py-3 text-black-500 dark:text-neutral-500" style="text-align:center">{{'Unisci in un unico PDF' | translate}}</th>
                            <th scope="col" class="px-6 py-3 text-black-500 dark:text-neutral-500"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (item of filesToUpload; track $index) {
                            <tr>
                                <td class="border" style="text-align:left" >
                                    <p-fileupload [disabled]="fileUploadStatus!=0" #fu mode="advanced" showUploadButton="false" showCancelButton="false" 
                                        chooseLabel="{{'Sfoglia' | translate}}" accept=".pdf, .p7m, image/*, .xml" [multiple]="true" chooseIcon="pi pi-paperclip" 
                                        (onSelect)="onSelectedFiles($event, item.idx)" (onRemove)="onRemoveFile($event, item.idx)">
                                        <ng-template #empty>
                                            <div class="flex items-center justify-center flex-col">{{'Trascina i files qui!' | translate}}</div>
                                        </ng-template>
                                    </p-fileupload>
                                </td>
                                <td class="border">
                                    <input pInputText type="text" [disabled]="!isOnlySameExtFile(item)" [(ngModel)]="item.pagesFilter" placeholder="{{'es. 3 o 1-3 o 1,2,5' | translate}}" [ngModelOptions]="{standalone: true}"/>
                                    <div class="flex flex-wrap gap-2 w-full" *ngIf="!isValidPagFilter(item.pagesFilter)">                  
                                        <small class="text-red-500" >{{"Inserire un valore per valido per Filtro Pagine." | translate}}</small>    
                                    </div>
                                </td>                            
                                <td class="border" style="text-align:center">
                                    <p-checkbox  [disabled]="!isMergeOnlySameExtFile(item)"   name="merge" [(ngModel)]="item.isMerge" [binary]="true" [ngModelOptions]="{standalone: true}"/>
                                </td>
                                <td class="border" style="text-align:center">
                                    <p-button [disabled]="fileUploadStatus!=0" icon="pi pi-trash" styleClass="w-full" class="mr-2" [outlined]="true" (click)="onDeleteUploadedItem(item.idx)" />                    
                                </td>
                            </tr>
                        }
                    </tbody>
                    </table>
                </div>                
            </div>                      

            <div class="flex flex-col md:flex-row gap-6 justify-center items-center" [hidden]="fileUploadStatus!=0">
                <div class="flex flex-wrap gap-2 w-full flex justify-center items-center mt-5"> 
                    <p-button [loading]="fileUploadProgressVisible" 
                    icon="pi pi-upload" [hidden]="!isFormValid()" label="{{'Invia Files' | translate}}" severity="primary" raised (click)="uploadFile()" />
                </div>             
            </div>

        </div>    
    </p-fluid>
    <hr>  
    @if(fileUploadStatus > 0) {
        <app-generic-process-status [pFileUploadDetailResponse]=fileUploadDetailResponse
            [pFileUploadProgressVisible]=fileUploadProgressVisible></app-generic-process-status>
    }
    @if(codeJson) {
        <app-generic-code-json-panel [pCodeJson]=codeJson [lstAttachmentDto]=lstAttachmentDto></app-generic-code-json-panel>
    }
    <div [hidden]="fileUploadStatus!=2">
        <hr>
         <div class="flex flex-col md:flex-row gap-6">
            <div class="flex flex-wrap gap-2 w-full">
                <p-button icon="pi pi-plus" [disabled]="!(this.fileUploadForm?.valid)" label="{{'Altro caricamento' | translate}}" severity="secondary" raised (click)="startNewUpload(false)" />
                <p-button icon="pi pi-reply" [disabled]="!(this.fileUploadForm?.valid)" label="{{'Nuova importazione' | translate}}" severity="secondary" raised (click)="startNewUpload(true)" />
                <p-button icon="pi pi-fw pi-inbox" [disabled]="!(this.fileUploadForm?.valid)" label="{{'Vai all\'archivio' | translate}}" severity="secondary" raised (click)="gotoStorico()" />
            </div>             
        </div>
    </div>
</div>
<app-generic-json-finder-preview-modal [dataInput]="dataInput" (hidePreviewEvent)="onHidePreviewEvent($event)" [visible]="showFinderPreview"></app-generic-json-finder-preview-modal>